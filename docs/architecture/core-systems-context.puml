@startuml CoreSystemsContext
!define RECTANGLE class
skinparam backgroundColor #ffffff
skinparam shadowing false
skinparam rectangle {
  FontSize 12
  BorderColor #1f2937
  RoundCorner 10
  FontColor #111827
  BackgroundColor #f3f4f6
}
skinparam packageStyle rectangle

rectangle "Discord User" as User #dbeafe
rectangle "Discord Interactions API" as DiscordAPI #bfdbfe
rectangle "FastAPI Edge" as FastAPI #ede9fe
rectangle "Command Registry" as Registry #e0f2fe
rectangle "Planner" as Planner #fef3c7
rectangle "Orchestrator" as Orchestrator #fef3c7
rectangle "Executor" as Executor #fef3c7
rectangle "Tool Registry" as ToolRegistry #ede9fe
rectangle "Events Ledger" as Events #fee2e2
rectangle "Postgres" as Postgres #e5e7eb
rectangle "Metrics/Tracing" as Observability #dcfce7
rectangle "LLM Provider" as LLM #fce7f3
rectangle "Retrieval" as Retrieval #ede9fe

User --> DiscordAPI : slash command
DiscordAPI --> FastAPI : interaction payload
FastAPI --> Registry : dispatch invocation
Registry --> Planner : /plan requests
Planner --> LLM : prompt & tools
Planner --> Registry : resolved command
Registry --> Orchestrator : /do requests
Orchestrator --> Retrieval : optional context
Retrieval --> Postgres : read-only queries
Orchestrator --> LLM : narration + mechanics prompt
Orchestrator --> Executor : tool chain
Executor --> ToolRegistry : schema validation
Executor --> Postgres : preview/apply mutations
Executor --> Events : append events
Events --> Postgres
FastAPI --> Observability : structured logs/metrics
Orchestrator --> Observability
Executor --> Observability
LLM --> Orchestrator : JSON proposal
FastAPI --> DiscordAPI : follow-up webhooks

@enduml
