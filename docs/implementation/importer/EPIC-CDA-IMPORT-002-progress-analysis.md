# EPIC-CDA-IMPORT-002 Progress Analysis

## Summary
- Implemented phase classes (`ManifestPhase`, `EntityPhase`, `EdgePhase`, `OntologyPhase`, `LorePhase`, and `FinalizationPhase`) establish the scaffold for manifest validation, content ingestion, and provenance tracking, with deterministic ordering, provenance metadata, and ImportLog generation already covered by targeted unit tests.【F:src/Adventorator/importer.py†L238-L1769】【F:tests/importer/test_entity_parser.py†L34-L207】【F:tests/importer/test_edge_parser.py†L36-L197】【F:tests/importer/test_importer_finalization.py†L21-L175】
- `ImporterRunContext` provides deterministic aggregation, deduplicated ImportLog handling, and canonical state digest computation validated by golden fixtures, meeting key prerequisites for replay invariants.【F:src/Adventorator/importer_context.py†L24-L205】【F:tests/importer/test_state_digest.py†L17-L160】【F:tests/importer/test_importer_context.py†L14-L145】
- Critical integration gaps remain: schema validation is stubbed, synthetic seed events are not consistently emitted in the orchestrated pipelines, database-run helper misroutes ontology/lore directories and expects fields never populated, metric names diverge from the EPIC specification, and feature-flag defaults contradict governance guidance.【F:src/Adventorator/manifest_validation.py†L32-L67】【F:src/Adventorator/importer.py†L589-L620】【F:src/Adventorator/importer.py†L2003-L2280】【F:src/Adventorator/importer.py†L484-L1528】【F:src/Adventorator/importer.py†L1974-L2010】

## Definition of Done Alignment

| DoD Item | Status | Evidence & Notes |
| --- | --- | --- |
| Phased importer with transactional/idempotent re-entry | ⚠️ *Partially Implemented* | Phase classes implement parsing, provenance, ImportLog entries, and deterministic ordering, and `run_complete_import_pipeline` stitches phases sequentially for in-memory runs.【F:src/Adventorator/importer.py†L238-L2443】 However `run_full_import_with_database` (the only database-integrated path) misuses directory roots (passing `ontologies/` and `lore/` instead of the package root) and assumes `event_payload` fields that are never attached, preventing end-to-end execution.【F:src/Adventorator/importer.py†L2171-L2255】【F:src/Adventorator/importer.py†L589-L620】 Transactional guarantees rely on `session_scope` but there is no phase-level savepoint or rollback orchestration yet. |
| Deterministic synthetic seed events | ⚠️ *Incomplete* | Manifest/entity/edge/ontology/lore phases define payload constructors and schema checks, yet neither orchestration path calls `create_seed_events`, so events are not emitted; the DB helper looks for `event_payload` keys that never exist.【F:src/Adventorator/importer.py†L589-L620】【F:src/Adventorator/importer.py†L826-L1773】【F:src/Adventorator/importer.py†L2171-L2255】 `persist_import_event` computes idempotency keys using the current `replay_ordinal`, conflicting with the EPIC mandate to exclude run-scoped fields.【F:src/Adventorator/importer.py†L41-L156】 Content chunk payload validation is enforced, but other event types early-return to bypass JSON schema checks, leaving gaps in payload determinism.【F:src/Adventorator/importer.py†L890-L934】 |
| Provenance recording via ImportLog | ✅ *Implemented with caveats* | Each phase attaches `{package_id, source_path, file_hash}` provenance and creates ImportLog entries merged by `ImporterRunContext`, with deduplication and sequence assignment validated by tests.【F:src/Adventorator/importer.py†L456-L520】【F:src/Adventorator/importer.py†L734-L838】【F:src/Adventorator/importer.py†L1043-L1186】【F:src/Adventorator/importer.py†L1612-L1706】【F:src/Adventorator/importer_context.py†L64-L198】 Finalization enforces contiguous sequencing and records a summary entry, but the raised error message (`"ImportLog sequence mismatch"`) does not match the test expectation (`"sequence gaps detected"`), causing divergence.【F:src/Adventorator/importer.py†L1836-L1883】【F:tests/importer/test_importer_finalization.py†L121-L149】 |
| Collision handling with negative tests | ✅ *Implemented* | Entity, edge, and lore phases detect same-stable-id/different-hash conflicts and emit structured rollback logs/metrics, with pytest suites covering collision and idempotent skip behaviors.【F:src/Adventorator/importer.py†L545-L586】【F:src/Adventorator/importer.py†L712-L767】【F:src/Adventorator/importer.py†L1637-L1689】【F:tests/importer/test_entity_parser.py†L132-L171】【F:tests/importer/test_edge_parser.py†L136-L197】【F:tests/test_lore_chunking.py†L180-L260】 |
| Replay/state digest stability | ⚠️ *Partially Implemented* | `ImporterRunContext.compute_state_digest` and associated tests (including golden fixture checks) demonstrate deterministic folding for in-memory data.【F:src/Adventorator/importer_context.py†L136-L205】【F:tests/importer/test_state_digest.py†L17-L160】 Yet `run_full_import_with_database` computes manifest hashes via ad-hoc `json.dumps(..., sort_keys=True)` instead of the canonical helper and does not persist or compare state digests after DB writes, weakening ledger-level guarantees.【F:src/Adventorator/importer.py†L2033-L2080】 |
| Metrics & logging per observability budget | ⚠️ *Misaligned* | Structured logging hooks exist, and counters are incremented across phases, but metric names diverge from the EPIC/IPD budget (e.g., `importer.entities.ingested` vs `importer.entities.created`, per-phase collision counters vs unified `importer.collision`).【F:src/Adventorator/importer.py†L71-L1528】 `record_idempotent_run` relies on a simple total skip heuristic rather than verifying ledger state, and no histogram tags/labels are propagated. |
| Feature flag gating | ⚠️ *Partial* | Each phase checks `features_importer_enabled`, but there is no central configuration binding—`run_full_import_with_database` defaults to `features_importer=True`, violating the “default disabled” requirement, and no settings dataclass exposes the flag.【F:src/Adventorator/importer.py†L238-L244】【F:src/Adventorator/importer.py†L1974-L2010】 Tests confirm the per-phase guardrails but not the global toggle path.【F:tests/test_importer_manifest.py†L28-L109】 |
| Golden fixtures & documentation | ✅ *Available* | Manifest, lore, and state digest fixtures live under `tests/fixtures/import/...`, with README guidance and tests exercising them. The EPIC document remains marked “Planned,” but code artifacts and tests demonstrate significant progress requiring documentation updates.【F:tests/fixtures/import/manifest/README.md†L1-L42】【F:tests/importer/test_state_digest_fixture.py†L14-L62】【F:docs/implementation/epics/EPIC-CDA-IMPORT-002-package-import-and-provenance.md†L178-L216】 |

## Key Implementation Gaps

1. **Schema validation stubs.** Both manifest and edge schema validators immediately return after loading the JSON schema, leaving mandatory field enforcement undone and allowing malformed artifacts to pass unnoticed.【F:src/Adventorator/manifest_validation.py†L32-L67】【F:src/Adventorator/importer.py†L987-L1012】
2. **Synthetic event emission disconnect.** `create_seed_events` helpers are unused and their outputs are never attached to phase results, so downstream persistence attempts fail. Integration needs to either embed payloads during parsing or call the helpers before database writes.【F:src/Adventorator/importer.py†L589-L620】【F:src/Adventorator/importer.py†L826-L1773】【F:src/Adventorator/importer.py†L2171-L2255】
3. **Database orchestrator defects.** Directory arguments are mis-specified (passing `ontologies/` instead of the package root causes double nesting), and Lore/ontology log entries are never persisted when directories are absent, undermining provenance completeness.【F:src/Adventorator/importer.py†L2224-L2254】
4. **Metric naming & flag defaults.** Metric keys must be realigned with the EPIC table and feature flags wired through configuration so that importer behavior is disabled by default in production builds.【F:src/Adventorator/importer.py†L484-L1528】【F:src/Adventorator/importer.py†L1974-L2010】
5. **Finalization messaging & ledger parity.** Error text should match the documented expectation (`"ImportLog sequence gaps detected"`), and idempotent detection should rely on ledger queries rather than skip counters to keep replay and hash-chain guarantees consistent with ADR-0006.【F:src/Adventorator/importer.py†L1815-L1883】【F:tests/importer/test_importer_finalization.py†L121-L149】

## Recommendations

- Re-enable canonical JSON schema validation across manifests, entities, edges, and events, updating fixtures as needed, to satisfy DoR/DoD requirements around deterministic structure enforcement.
- Integrate `create_seed_events` outputs into both orchestration paths and persist canonical payload hashes via `compute_canonical_hash` before calling `persist_import_event`, ensuring idempotency keys exclude `replay_ordinal` per EPIC guidance.
- Fix `run_full_import_with_database` to pass the package root into each phase, attach manifest hashes to the manifest dict before reuse, and surface phase outputs that include ImportLog entries and event payloads; add regression tests that execute the full DB workflow.
- Harmonize metrics with the observability plan (`importer.entities.created`, `importer.collision`, etc.) and expose feature flags through the repository `Settings` dataclass with defaults set to `False` in `config.toml`.
- Update EPIC status tables and governance docs to reflect the current code/test coverage once the above gaps are closed, ensuring traceability remains accurate.
