# EPIC-CDA-IMPORT-002 Progress Review — Package Import & Provenance

_Date:_ 2025-09-26

## Summary
- All importer phases (manifest, entities, edges, ontology, lore, finalization) are implemented with feature-flag gating, provenance capture, and deterministic ordering helpers, indicating substantial progress beyond the "Planned" status recorded in the epic roll-up.【F:src/Adventorator/importer.py†L240-L245】【F:src/Adventorator/importer.py†L368-L501】【F:src/Adventorator/importer.py†L630-L824】【F:src/Adventorator/importer.py†L1021-L1332】【F:src/Adventorator/importer.py†L1551-L1703】【F:src/Adventorator/importer.py†L1778-L1882】
- Contract and ordering tests exercise each phase, but key automated checks fail today because metric names, event payload wiring, and ImportLog sequencing diverge from test expectations and Definition-of-Done criteria.【F:tests/importer/test_entity_seed_events.py†L10-L169】【F:tests/importer/test_edge_parser.py†L20-L197】【F:tests/importer/test_importer_finalization.py†L14-L121】【a2d896†L1-L13】
- Schema and payload validation are only partially enforced—manifest schema validation is stubbed out and event payload checking is limited to lore chunks—leaving coverage gaps called out in ADR-0011/ADR-0006.【F:src/Adventorator/manifest_validation.py†L32-L67】【F:src/Adventorator/importer.py†L900-L935】
- Database integration paths exist, but missing ImportLog sequencing and absent seed event payload propagation cause integrity failures when the async pipeline is executed end-to-end.【F:src/Adventorator/importer.py†L2164-L2270】【F:src/Adventorator/importer.py†L467-L481】【F:src/Adventorator/importer.py†L2190-L2202】【a2d896†L9-L13】

## Methodology
- Reviewed implementation in `src/Adventorator/importer.py`, `manifest_validation.py`, and the supporting `ImporterRunContext` aggregation utilities.【F:src/Adventorator/importer.py†L240-L245】【F:src/Adventorator/importer.py†L1778-L1970】【F:src/Adventorator/manifest_validation.py†L32-L138】【F:src/Adventorator/importer_context.py†L60-L218】
- Examined targeted story-level tests under `tests/importer/` to confirm planned acceptance criteria and detect failing assertions.【F:tests/importer/test_entity_seed_events.py†L10-L169】【F:tests/importer/test_edge_parser.py†L20-L197】【F:tests/importer/test_importer_finalization.py†L14-L186】【F:tests/importer/test_importer_idempotency.py†L401-L503】
- Executed `pytest tests/importer -q` to validate the suite; numerous failures surfaced in metrics, ImportLog sequencing, and database integration checks.【531b27†L1-L115】

## Story-by-Story Assessment

| Story | Implementation evidence | Validation status | Gaps & risks |
| --- | --- | --- | --- |
| 002A — Manifest validation & package registration | `ManifestPhase.validate_and_register` enforces the feature flag, canonical hashing, event payload construction, and ImportLog entry creation.【F:src/Adventorator/importer.py†L261-L295】 The validator computes deterministic hashes and checks content_index integrity.【F:src/Adventorator/manifest_validation.py†L70-L138】 | Integration tests load manifests and verify hash outputs and seed event structure.【F:tests/importer/test_integration_complete_workflow.py†L13-L88】 | JSON schema validation is disabled (`return` early) and event payload schema checks are skipped for manifest events, so malformed manifests can still pass DoD requirements for TASK-CDA-IMPORT-MAN-01/SEED-03.【F:src/Adventorator/manifest_validation.py†L60-L67】【F:src/Adventorator/importer.py†L900-L909】 |
| 002B — Entity ingestion & seed events | Entity parsing normalizes content, validates schema, records provenance, emits ImportLog entries, and increments metrics (currently `importer.entities.ingested`).【F:src/Adventorator/importer.py†L368-L490】 Seed event factory covers optional fields and schema validation hooks.【F:src/Adventorator/importer.py†L589-L621】 | Ordering and payload tests confirm deterministic sequencing and provenance fields.【F:tests/importer/test_entity_seed_events.py†L13-L169】 | Metrics use `*.ingested` while tests (and documentation) expect `*.created`, causing suite failures and observability drift.【F:src/Adventorator/importer.py†L483-L490】【F:tests/importer/test_entity_metrics.py†L18-L91】 Parsed entities never store `event_payload`, so database execution path skips actual seed event persistence, violating DoD for synthetic events.【F:src/Adventorator/importer.py†L2190-L2196】【F:src/Adventorator/importer.py†L589-L621】 |
| 002C — Edge ingestion & temporal validity | Edge phase enforces feature flag, taxonomy validation, provenance logging, deterministic sorting, and ImportLog assembly.【F:src/Adventorator/importer.py†L630-L807】 | Unit tests cover invalid references, type enforcement, and ordering, demonstrating parser breadth.【F:tests/importer/test_edge_parser.py†L60-L197】 | Metrics again use `importer.edges.ingested`, conflicting with contract expectations (`*.created`) and failing tests.【F:src/Adventorator/importer.py†L807-L815】【F:tests/importer/test_edge_metrics.py†L18-L108】 Database path looks for `edge["event_payload"]`, which is never set, so no `seed.edge_created` envelopes are stored; ImportLog sequence numbers are also missing when context aggregates results.【F:src/Adventorator/importer.py†L2190-L2216】【F:src/Adventorator/importer.py†L780-L805】 |
| 002D — Ontology registration | Ontology phase handles plural directory fallbacks, duplicate detection per ADR-0011, provenance, metrics, and seed event emission scaffolding.【F:src/Adventorator/importer.py†L1021-L1332】 | Tests assert duplicate handling, metrics, and tag/affordance schema expectations.【F:tests/importer/test_ontology_ingestion.py†L1-L169】【F:tests/importer/test_ontology_metrics.py†L1-L160】 | Metrics names differ from Definition of Done (`importer.tags.parsed`/`registered` vs. documented `importer.tags.registered` only), and the code emits structured logs instead of actual ledger events, leaving DoD for synthetic seed events unverified. Event payload schema validation is bypassed because `validate_event_payload_schema` returns early for non-lore events.【F:src/Adventorator/importer.py†L900-L909】【F:src/Adventorator/importer.py†L1334-L1381】 |
| 002E — Lore chunking & ingestion | Lore phase integrates `LoreChunker`, provenance, collision detection, ImportLog creation, metrics, and content chunk seed payload generation.【F:src/Adventorator/importer.py†L1551-L1775】 | Tests drive LorePhase through the state digest and rollback suites, confirming deterministic hashing and provenance propagation.【F:tests/importer/test_state_digest.py†L147-L195】【F:tests/importer/test_importer_rollback.py†L336-L395】 | Database integration emits `seed.lore_chunk_created` instead of the documented `seed.content_chunk_ingested`, and chunk dictionaries lack `event_payload`, so no ledger events persist. Metric naming again diverges (`*.ingested`).【F:src/Adventorator/importer.py†L2242-L2248】【F:src/Adventorator/importer.py†L1742-L1775】 |
| 002F — Finalization & ImportLog consolidation | `FinalizationPhase` computes counts, state digests, completion events, ImportLog summary, and duration histogram, matching ADR-0011 expectations.【F:src/Adventorator/importer.py†L1778-L1970】 | Tests assert completion payload structure, digest stability, ImportLog summary construction, and duration metric recording.【F:tests/importer/test_importer_finalization.py†L14-L186】 | Sequence gap enforcement raises an error with message text different from the test expectation, causing the suite to fail; summary generation also assumes prior sequence numbering that the database path never assigns.【F:src/Adventorator/importer.py†L1949-L1953】【F:tests/importer/test_importer_finalization.py†L93-L133】 |
| 002G — Idempotent re-run & rollback | `run_full_import_with_database` stitches all phases, computes hash chain tips, and records idempotent runs; rollback helpers log structured events.【F:src/Adventorator/importer.py†L2164-L2345】 | Database-focused tests create campaigns, run the importer twice, and inspect ledger/ImportLog state to prove idempotency, but currently fail because integrity constraints are tripped before assertions run.【F:tests/importer/test_importer_idempotency.py†L401-L503】【531b27†L1-L38】 | Missing campaign bootstrap inside `persist_import_event` calls leads to foreign key failures when tests rely on fixture-provided sessions, and the absence of populated `event_payload` fields prevents ledger inserts. ImportLog sequence mismatch also aborts reruns before idempotency can be observed.【F:src/Adventorator/importer.py†L102-L199】【F:src/Adventorator/importer.py†L2190-L2202】【a2d896†L9-L13】 |

## Additional Observations
- The epic traceability table still lists every story as "Planned", which no longer reflects the implementation reality and makes governance reporting inaccurate.【F:docs/implementation/epics/EPIC-CDA-IMPORT-002-package-import-and-provenance.md†L168-L188】
- Seed event schema files exist under `contracts/events/seed/`, but current code only enforces them for lore chunks; consider re-enabling validation once ULID fixtures are corrected to meet the Definition of Ready expectations.【F:src/Adventorator/importer.py†L900-L918】
- Metrics helper `inc_counter` simply delegates to the global counter registry, so renaming metrics requires coordinating with `tests/importer` expectations and Observability specs in the epic.【F:src/Adventorator/importer.py†L36-L52】【F:tests/importer/test_entity_metrics.py†L18-L91】
- The production-oriented `run_complete_import_pipeline` mirrors the multi-phase flow but similarly omits event payload propagation and ImportLog sequence assignment before context aggregation, leaving finalization susceptible to the same gaps noted in the async database path.【F:src/Adventorator/importer.py†L2352-L2455】

## Recommended Next Steps
1. Align metric names and counters with documented expectations (`*.created`, `*.registered`, etc.) and update tests accordingly to restore observability coverage.【F:src/Adventorator/importer.py†L483-L490】【F:tests/importer/test_entity_metrics.py†L18-L91】
2. Attach `event_payload` dictionaries to parsed entities, edges, ontology items, and lore chunks so `run_full_import_with_database` can persist synthetic `seed.*` events; confirm ledger hash chain behavior once payloads flow end-to-end.【F:src/Adventorator/importer.py†L589-L621】【F:src/Adventorator/importer.py†L2190-L2248】
3. Restore manifest and seed event schema validation per ADR-0011/0006, updating fixtures to produce valid ULIDs and payloads to satisfy negative tests in STORY 002A/002B/002C.【F:src/Adventorator/manifest_validation.py†L60-L67】【F:src/Adventorator/importer.py†L900-L935】
4. Revisit ImportLog sequence management so context aggregation and database persistence share the same counters before finalization enforces contiguity; this should unblock idempotent rerun and rollback test suites.【F:src/Adventorator/importer.py†L2168-L2270】【F:src/Adventorator/importer_context.py†L72-L118】
5. Update the epic status roll-up once the above gaps are resolved to accurately communicate readiness across governance artifacts.【F:docs/implementation/epics/EPIC-CDA-IMPORT-002-package-import-and-provenance.md†L168-L188】
