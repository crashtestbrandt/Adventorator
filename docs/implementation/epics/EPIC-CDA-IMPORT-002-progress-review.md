# EPIC-CDA-IMPORT-002 Implementation Progress Review

## Scope & Methodology
- **Artifacts reviewed.** `src/Adventorator/importer.py`, `importer_context.py`, `manifest_validation.py`, `lore_chunker.py`, metrics utilities, and importer-focused tests under `tests/importer/`.
- **Reference epic.** [EPIC-CDA-IMPORT-002 — Package Import & Provenance](EPIC-CDA-IMPORT-002-package-import-and-provenance.md).
- **Validation steps.** Manual code walkthrough plus execution of the importer test suite (`pytest tests/importer -q`). The suite currently fails with metric, ImportLog sequencing, and database foreign-key errors, confirming several Definition of Done gaps.

## Definition of Done Gap Analysis

| Requirement (Epic §DoD) | Evidence | Status | Notes |
| --- | --- | --- | --- |
| Phased importer with transactional boundaries and idempotent re-entry | `run_full_import_with_database` orchestrates manifest→entity→edge→ontology→lore→finalization, persisting events and ImportLog rows in a single session scope.【F:src/Adventorator/importer.py†L2003-L2314】 | ⚠️ Partial | Pipeline exists, but integration tests fail due to ImportLog sequence mismatches and foreign-key violations when persisting events, preventing successful commits.【7158e3†L1-L114】【7158e3†L115-L183】 |
| Deterministic synthetic seed events with stable replay ordinals & hashing | `persist_import_event` computes replay ordinals, hash chain links, payload hashes, and idempotency keys for synthetic events.【F:src/Adventorator/importer.py†L66-L152】 | ⚠️ Partial | Event generation logic is in place, yet DB enforcement fails because prerequisite campaign/scene setup is insufficient for SQLite tests, and lore phase emits `seed.lore_chunk_created` instead of required `seed.content_chunk_ingested` payloads.【F:src/Adventorator/importer.py†L2243-L2249】【7158e3†L115-L183】 |
| Provenance recorded in ImportLog with phase/object/file hashes | Each phase attaches provenance metadata and produces ImportLog entries with phase/object/type/hash fields prior to persistence.【F:src/Adventorator/importer.py†L272-L295】【F:src/Adventorator/importer.py†L431-L505】【F:src/Adventorator/importer.py†L770-L842】【F:src/Adventorator/importer.py†L1479-L1543】【F:src/Adventorator/importer.py†L1716-L1755】 | ⚠️ Partial | Context merge keeps entries, but finalization raises `ImportLog sequence mismatch` because sequence assignment diverges between context bookkeeping and DB writes, blocking completion.【7158e3†L1-L114】 |
| Collision handling with descriptive failures | Entity, edge, and lore phases detect stable ID/hash conflicts and raise `EntityCollisionError`, `EdgeCollisionError`, `LoreCollisionError` with rollback logging.【F:src/Adventorator/importer.py†L560-L588】【F:src/Adventorator/importer.py†L726-L760】【F:src/Adventorator/importer.py†L1662-L1705】 | ✅ Met | Tests confirm collision exceptions, although metric names (`importer.entities.collisions`) do not match spec/test expectations (`importer.collision`).【F:src/Adventorator/importer.py†L732-L740】【6b299c†L60-L99】 |
| Replay test ensuring stable `state_digest` and no duplicate ledger events | Finalization computes canonical state digests via `ImporterRunContext`, and idempotent path in `run_full_import_with_database` short-circuits when prior completion event exists.【F:src/Adventorator/importer_context.py†L134-L207】【F:src/Adventorator/importer.py†L2030-L2122】 | ⚠️ Partial | Digest computation exists, but automated database replay test fails due to ImportLog sequencing & FK errors, so end-to-end replay invariants remain unverified.【7158e3†L1-L183】 |
| Structured logging & metrics coverage (`importer.entities.created`, etc.) | Structured logs emitted per phase; counters incremented for entities/edges/lore and idempotent runs.【F:src/Adventorator/importer.py†L460-L489】【F:src/Adventorator/importer.py†L796-L813】【F:src/Adventorator/importer.py†L1732-L1770】【F:src/Adventorator/importer.py†L1815-L1876】 | ❌ Not Met | Metric names diverge from spec/test expectations (`*.ingested` vs `*.created`), and counters never reach asserted values, causing multiple test failures.【d85bc5†L1-L1】【0b2d5a†L1-L1】【6b299c†L18-L77】【7158e3†L1-L114】 |
| Feature flag `features.importer` gates activation | Each phase constructor enforces the flag and raises when disabled.【F:src/Adventorator/importer.py†L238-L370】【F:src/Adventorator/importer.py†L627-L641】【F:src/Adventorator/importer.py†L1578-L1634】【F:src/Adventorator/importer.py†L1781-L1801】 | ✅ Met | Tests cover disabled-path behavior in phase-specific suites.【24ce72†L41-L120】 |
| Golden fixtures committed & quality gates green | Fixtures for manifest/entity scenarios exist under `tests/fixtures/import/`, but importer test suite fails, so quality gates are not green.【7158e3†L1-L183】 | ❌ Not Met | Additional fixtures for golden manifests exist, yet failing pytest run blocks DoD completion. |
| Documentation of phase ordering, failure semantics, provenance | No developer guide or appendix produced alongside implementation; epic remains only source. | ❌ Not Met | Need dedicated documentation describing pipeline behavior beyond inline code comments. |

## Story-by-Story Status Highlights

- **STORY-CDA-IMPORT-002A (Manifest).** Core validation flow implemented with feature-flag guard, manifest hashing, and seed event payloads.【F:src/Adventorator/importer.py†L235-L315】 Negative schema cases covered in tests, but execution halts before ledger persistence because downstream phases fail.
- **STORY-CDA-IMPORT-002B (Entities).** Parser enforces deterministic ordering, provenance, and collision detection.【F:src/Adventorator/importer.py†L342-L505】 Metrics misnamed and schema validator stubbed (`validate_entity_schema`) indicates pending schema integration.【F:src/Adventorator/importer.py†L406-L414】
- **STORY-CDA-IMPORT-002C (Edges).** Taxonomy-aware validation, provenance logging, and seed event payload creation implemented.【F:src/Adventorator/importer.py†L624-L875】 Metrics mismatches mirror entity phase; referential integrity tests still failing because global counters remain zero.【7158e3†L1-L114】
- **STORY-CDA-IMPORT-002D (Ontology).** Tag/affordance normalization with provenance and ImportLog entries present, plus structured logs and metrics placeholders.【F:src/Adventorator/importer.py†L1479-L1569】 Event emission uses helper but lacks dedicated tests validating schema payloads.
- **STORY-CDA-IMPORT-002E (Lore).** Lore chunking integrates with `LoreChunker` and enforces provenance, but emits `seed.lore_chunk_created` instead of the expected `seed.content_chunk_ingested`, breaking contract alignment.【F:src/Adventorator/importer.py†L1706-L1775】 Unicode normalization and audience enforcement rely on chunker behavior; dedicated hashing tests exist under `tests/test_lore_chunking.py`.
- **STORY-CDA-IMPORT-002F (Finalization).** Finalization builds completion payloads, logs, and duration histogram, but ImportLog sequence enforcement currently raises errors, stopping the pipeline.【F:src/Adventorator/importer.py†L1778-L1970】【7158e3†L1-L114】
- **STORY-CDA-IMPORT-002G (Idempotent rerun).** Idempotent short-circuit logic exists in database runner, yet rerun tests fail because first run never completes successfully (ImportLog sequence + FK issues).【F:src/Adventorator/importer.py†L2059-L2122】【7158e3†L1-L183】

## Key Gaps & Recommendations
1. **Align metrics and event names with epic/test expectations.** Rename counters to `importer.entities.created`, `importer.edges.created`, etc., and emit `seed.content_chunk_ingested` for lore chunks to match contracts and failing tests.【d85bc5†L1-L1】【0b2d5a†L1-L1】【F:src/Adventorator/importer.py†L2243-L2249】
2. **Stabilize ImportLog sequencing.** Reconcile `ImporterRunContext` numbering with database persistence to eliminate `ImportLog sequence mismatch` exceptions during finalization.【F:src/Adventorator/importer_context.py†L82-L157】【7158e3†L1-L114】
3. **Resolve database FK failures.** Ensure campaigns/scenes created in tests align with persisted events (likely by seeding campaigns within the async session or adjusting FK constraints) so ledger inserts succeed.【F:src/Adventorator/importer.py†L66-L152】【7158e3†L115-L183】
4. **Document operational workflow.** Produce a developer-facing guide describing phase ordering, feature flag behavior, provenance recording, and rollback strategy to fulfill epic documentation requirements.
5. **Re-run quality gates after fixes.** Current pytest failures block DoD acceptance; address above issues then re-run `pytest tests/importer -q` and broader quality gates per repository guidelines.
