# EPIC-CDA-IMPORT-002 Progress Review — Package Import & Provenance

## Overview
This report audits the current implementation against the Definition of Done for EPIC-CDA-IMPORT-002. The analysis spans importer pipeline modules, provenance context helpers, contracts, and the associated unit/integration tests. Evidence is cited inline to highlight where requirements are satisfied, partially met, or still outstanding.

## Definition of Done Evaluation
| DoD Requirement | Status | Evidence & Notes |
| --- | --- | --- |
| Phased importer with transactions and idempotent re-entry | ⚠️ Partial | `run_full_import_with_database` orchestrates manifest→entity→edge→ontology→lore→finalization inside `session_scope`, committing or rolling back as one transaction and short-circuiting reruns when a matching manifest hash already exists.【F:src/Adventorator/importer.py†L2003-L2349】【F:src/Adventorator/db.py†L144-L156】 However, phase outputs are not wired back into event emission (see below), so ledger replay coverage remains incomplete. |
| Deterministic synthetic seed events with stable replay ordinals & payload hashing | ❌ Missing | Event persistence computes payload and envelope hashes, but it seeds the idempotency key with a millisecond timestamp, so reruns will produce different keys. Moreover, the importer never attaches generated entity/edge/lore payloads to phase results, so the guarded `persist_import_event` calls are no-ops for those phases.【F:src/Adventorator/importer.py†L123-L217】【F:src/Adventorator/importer.py†L589-L620】【F:src/Adventorator/importer.py†L2191-L2248】 |
| Provenance recorded via ImportLog | ✅ Complete | Each phase attaches ImportLog metadata (phase, stable_id, file_hash, action), and the database runner assigns sequence numbers before persisting, guaranteeing ledger-aligned provenance entries.【F:src/Adventorator/importer.py†L467-L481】【F:src/Adventorator/importer.py†L795-L805】【F:src/Adventorator/importer.py†L1668-L1681】【F:src/Adventorator/importer.py†L2178-L2242】 |
| Collision handling with negative tests | ✅ Complete | Entity, edge, and lore phases guard against stable_id collisions and raise explicit exceptions; targeted tests cover hash mismatches, duplicate IDs, and taxonomy violations per story plans.【F:src/Adventorator/importer.py†L455-L487】【F:src/Adventorator/importer.py†L758-L775】【F:src/Adventorator/importer.py†L1658-L1666】【F:tests/importer/test_entity_parser.py†L90-L200】【F:tests/importer/test_edge_parser.py†L109-L196】 |
| Replay test verifying stable state digest and no duplicate events | ⚠️ Partial | Idempotency tests assert identical state digests across reruns using `ImporterRunContext.compute_state_digest`, but they currently rely on state equality rather than verifying that no new ledger events were persisted or that the idempotent counter increments.【F:src/Adventorator/importer_context.py†L164-L277】【F:tests/importer/test_importer_idempotency.py†L40-L160】 |
| Structured logging & metrics (`importer.*`) | ⚠️ Partial | All phases emit structured logs and counters, yet metric names diverge from the epic (`importer.entities.ingested` vs. expected `importer.entities.created`), breaking existing tests and observability conventions.【F:src/Adventorator/importer.py†L492-L498】【F:src/Adventorator/importer.py†L809-L815】【F:src/Adventorator/importer.py†L1683-L1699】【F:tests/importer/test_edge_parser.py†L58-L136】 |
| Feature flag gating (`features.importer`, embeddings) | ✅ Complete | Each phase short-circuits when disabled, and unit tests confirm the guard rails for manifest, entity, and edge stages.【F:src/Adventorator/importer.py†L261-L315】【F:src/Adventorator/importer.py†L368-L384】【F:src/Adventorator/importer.py†L636-L640】【F:tests/test_importer_manifest.py†L28-L35】【F:tests/importer/test_entity_parser.py†L24-L40】【F:tests/importer/test_edge_parser.py†L36-L47】 |
| Quality gates, fixtures, and documentation | ⚠️ Partial | Golden fixtures exist for manifest and full importer flows, and finalization tests exercise the import-complete contract. The epic document still lists every story as “Planned,” and canonical schema validation remains disabled, so governance artifacts need updates to declare readiness.【F:tests/test_importer_manifest.py†L31-L195】【F:tests/importer/test_importer_finalization.py†L21-L175】【F:contracts/events/seed/import-complete.v1.json†L1-L72】【F:docs/implementation/epics/EPIC-CDA-IMPORT-002-package-import-and-provenance.md†L192-L199】【F:src/Adventorator/manifest_validation.py†L32-L67】 |

## Story-by-Story Findings
- **002A — Manifest validation & package_id registration.** Feature flagging, ImportLog, and synthetic event scaffolding exist with dedicated tests, but JSON schema enforcement is stubbed out, leaving tamper detection reliant solely on hash mismatches.【F:src/Adventorator/importer.py†L235-L315】【F:src/Adventorator/manifest_validation.py†L32-L67】【F:tests/test_importer_manifest.py†L36-L195】 
- **002B — Entity ingestion & synthetic events.** Deterministic sorting, provenance, and collision handling are implemented and well-tested; however, seed event payloads are never attached to the parsed entities, so downstream emission paths stay dormant and metrics use non-canonical names.【F:src/Adventorator/importer.py†L342-L620】【F:tests/importer/test_entity_parser.py†L18-L200】【F:tests/importer/test_entity_seed_events.py†L13-L176】 
- **002C — Edge ingestion & temporal validity.** Edge parser enforces taxonomy requirements and referential integrity with coverage for negative scenarios, but shares the metrics naming drift and lacks wiring to event persistence.【F:src/Adventorator/importer.py†L630-L824】【F:tests/importer/test_edge_parser.py†L20-L196】 
- **002D — Ontology registration.** Tag and affordance normalization, duplicate checks, and metrics exist with structured logging; tests validate event payload composition and ImportLog emission, yet no integration ensures database persistence or contract validation for affordances.【F:src/Adventorator/importer.py†L1032-L1531】 
- **002E — Lore chunking & ingestion.** Lore chunker enforces front-matter schemas, audience gating, deterministic chunk hashing, and ImportLog wiring. Event payload creation is present but not yet invoked by the orchestration path.【F:src/Adventorator/importer.py†L1534-L1773】【F:src/Adventorator/lore_chunker.py†L1-L210】 
- **002F — Finalization & ImportLog consolidation.** Finalization phase produces the `seed.import.complete` payload, logs counts, records histogram metrics, and validates ImportLog continuity. Contract and integration tests cover the completion schema and state digest behavior.【F:src/Adventorator/importer.py†L1803-L1909】【F:contracts/events/seed/import-complete.v1.json†L1-L72】【F:tests/importer/test_importer_finalization.py†L21-L175】 
- **002G — Idempotent re-run & rollback tests.** Database runner checks for prior imports and reports idempotent skips, while tests assert stable digests and replay ordinals; nonetheless, idempotency metrics remain observational only and do not yet confirm absence of new ledger envelopes.【F:src/Adventorator/importer.py†L2053-L2153】【F:tests/importer/test_importer_idempotency.py†L40-L159】 

## Key Gaps & Risks
1. **Event emission contract not satisfied.** Entity, edge, ontology, and lore phases generate seed payloads but never surface them to `run_full_import_with_database`, preventing ledger inserts and violating replay determinism goals.【F:src/Adventorator/importer.py†L589-L620】【F:src/Adventorator/importer.py†L2191-L2248】 
2. **Idempotency key instability.** Timestamp-based execution request identifiers undermine deterministic idempotency keys, risking duplicate envelopes on retried imports and conflicting with ADR-0006/CORE expectations.【F:src/Adventorator/importer.py†L123-L166】 
3. **Observability drift vs. contracts/tests.** Metrics emit `*.ingested` counters whereas story tests and DoD require `*.created`, causing broken assertions and inconsistent dashboards.【F:src/Adventorator/importer.py†L484-L490】【F:src/Adventorator/importer.py†L809-L815】【F:tests/importer/test_edge_parser.py†L58-L136】 
4. **Schema validation disabled.** Manifest validation short-circuits before invoking JSON Schema, leaving contract regressions undetected until downstream phases.【F:src/Adventorator/manifest_validation.py†L32-L67】 
5. **Governance artifacts lag implementation.** Epic roll-up still marks all stories as “Planned,” masking the substantial in-repo progress and making audit trails incomplete.【F:docs/implementation/epics/EPIC-CDA-IMPORT-002-package-import-and-provenance.md†L192-L199】 

## Recommended Next Steps
1. **Wire seed event payloads into persistence.** Have each phase attach its `create_seed_events` output (or compute inline) before `run_full_import_with_database` attempts to persist, ensuring replay_ordinals and payload hashes are stored deterministically. 
2. **Stabilize idempotency inputs.** Replace timestamp-derived execution IDs with manifest/package-derived identifiers or adopt `compute_idempotency_key_v2` inputs so replays hash identically. 
3. **Align metrics with DoD.** Rename counters to the agreed contract (`importer.entities.created`, etc.) and update tests/alerts simultaneously to restore observability parity. 
4. **Re-enable manifest schema validation.** Fix fixtures to satisfy the contract and remove the early return so invalid manifests fail fast. 
5. **Update governance docs.** Refresh the epic status table and back-link implemented stories, noting remaining defects (event wiring, idempotency) for traceability. 

## Test & Fixture Coverage Snapshot
- Manifest, entity, edge, and finalization test suites validate feature flags, collision handling, ImportLog entries, and completion payload structure.【F:tests/test_importer_manifest.py†L28-L195】【F:tests/importer/test_entity_parser.py†L24-L200】【F:tests/importer/test_edge_parser.py†L36-L196】【F:tests/importer/test_importer_finalization.py†L21-L175】 
- Idempotency regression tests exercise reruns and state digest stability, backed by `ImporterRunContext` hashing helpers.【F:tests/importer/test_importer_idempotency.py†L40-L159】【F:src/Adventorator/importer_context.py†L164-L277】 
- Contracts include a `seed.import.complete` schema, and golden fixtures live under `tests/fixtures/import/manifest/happy-path`, though schema validation presently bypasses enforcement.【F:contracts/events/seed/import-complete.v1.json†L1-L72】【F:tests/test_importer_manifest.py†L36-L195】【F:src/Adventorator/manifest_validation.py†L32-L67】 

