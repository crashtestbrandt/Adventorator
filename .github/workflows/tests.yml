name: tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        db: [sqlite, postgres]
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: adventorator
          POSTGRES_PASSWORD: adventorator
          POSTGRES_DB: adventorator
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U adventorator -d adventorator"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10
        # Only needed when matrix.db == 'postgres'; harmless otherwise
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
      - name: Prepare database (Postgres only)
        if: matrix.db == 'postgres'
        env:
          PGPASSWORD: adventorator
          DATABASE_URL: postgresql+asyncpg://adventorator:adventorator@localhost:5432/adventorator
        run: |
          # Create a separate test DB if desired (optional)
          psql -h localhost -U adventorator -d adventorator -c 'SELECT 1;' || true
          # Apply migrations using sync psycopg driver via Alembic env.py
          PYTHONPATH=./src alembic upgrade head
      - name: Run tests (matrix)
        env:
          ENV: dev
          DISCORD_PUBLIC_KEY: dummy
          DATABASE_URL: ${{ matrix.db == 'postgres' && 'postgresql+asyncpg://adventorator:adventorator@localhost:5432/adventorator' || 'sqlite+aiosqlite:///./adventorator_test.sqlite3' }}
        run: |
          pytest -q

  quality-gates:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run coverage with threshold
        env:
          ENV: dev
          DISCORD_PUBLIC_KEY: dummy
          DATABASE_URL: sqlite+aiosqlite:///./adventorator_cov.sqlite3
          PYTHONPATH: ./src
        run: |
          pytest --cov=Adventorator --cov-report=term-missing --cov-fail-under=80

      - name: Run targeted mutation guard
        env:
          PYTHONPATH: ./src
          ENV: dev
          DISCORD_PUBLIC_KEY: dummy
          DATABASE_URL: sqlite+aiosqlite:///./adventorator_mut.sqlite3
        run: |
          python scripts/check_mutation_guard.py

      - name: Security scan (Bandit)
        run: |
          bandit -q -r src -ll

      - name: Validate performance budgets
        run: |
          python scripts/check_performance_budgets.py

      - name: Validate prompts and contracts
        run: |
          python scripts/validate_prompts_and_contracts.py

      - name: Validate AI evaluation definitions
        run: |
          python scripts/run_ai_evals.py
